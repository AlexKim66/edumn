<template>
    <section class="print-container">
        <div class="print-tools no-print">
            <div class="print-tools-left">
                <label>Excel Файлаас өгөгдөл шинэчлэх</label>
            </div>
        </div>

        <div class="print-body">
            <Spin size="large" fix v-if="isLoading"></Spin>

        </div>
    </section>
</template>

<script>
import axios from "axios"
import {Printd} from 'printd'
import {getPrintStyles} from "./utils/printStyles"

export default {
    props: ["schemaID", "schema", "query"],

    data() {
        return {
            isLoading: true,
            isFalse: false,
            isTrue: true,
            total: 0,
            data: [],
            scrollOptions: {
                height: '100%',
                size: 7,
                railVisible: true,
                railOpacity: 0.2,
                alwaysVisible: true,
                wheelStep: 5,
                color: '#2C3A47'
            },
            cssText: getPrintStyles,
            templatecss: " @media print{@page {size: A4}}",
            valute: ''
        }
    },

    created() {
        this.d = new Printd();
        this.fetchPrintData();
    },

    methods: {
        cssPagedMedia: (function () {
            var style = document.createElement('style');
            document.head.appendChild(style);
            return function (rule) {
                style.innerHTML = rule;
            };
        }()),

        changeCss() {
            this.templatecss = " @media print{@page {size: " + this.pageSize + "}}";
        },

        printPage() {
            this.d.print(document.getElementById('printArea'), [this.templatecss, this.cssText]);
        },
        refreshData() {
            alert(this.valute);
        },

        fetchPrintData() {
            this.isLoading = true;
            let url = `/lambda/krud/print/${this.schemaID}`;
            let filters = Object.keys(this.filter)
                .filter(e => this.filter[e] !== null)
                .reduce((o, e) => {
                    o[e] = this.filter[e];
                    return o;
                }, {});

            axios
                .post(url, filters)
                .then(({data}) => {
                    this.data = data;
                    this.isLoading = false;
                })
                .catch(e => {
                    console.log(e.message);
                    this.isLoading = false;
                });
        },

        printCell(tr, td) {
            switch (td.gridType) {
                case "Number":
                    return Number(tr[td.model]).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
                case "Image":
                    return `<img src="${tr[td.model]}"/>`
                case "Html":
                    return tr[td.model];
                case "Date":
                    return tr[td.model] != null ? tr[td.model].substr(0, 10) : ''
                default:
                    return tr[td.model]
            }
        }
    }
};
</script>

<style lang="scss">
@import "./scss/print.scss";
</style>
