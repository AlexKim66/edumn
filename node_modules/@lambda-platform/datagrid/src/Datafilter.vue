<template>
    <div class="dg-filter">
        <div class="dg-filter-widget">
            <div class="dg-filter-widget-header">
                <h3>Мэдээлэл шүүх</h3>
            </div>
            <div class="dg-filter-widget-body">
                <Form ref="filterFrm" :model="model" label-position="top">
                    <FormItem v-for="item in schema" v-if="item.filterable && item.filter && item.filter.type && item.filter.showSideFilter !== false"
                              :key="item.index">
                        <component :is="element(item.filter.type)" :model="{form: model, component: item.model}"
                                   :label="item.filter.label ? item.filter.label : item.label" :meta="setMeta(item)">
                        </component>
                    </FormItem>
                    <FormItem>
                        <Button type="primary" long @click="$parent.filterData(1)">Шүүж харах</Button>
                    </FormItem>
                    <br/>
                </Form>
            </div>
            <div v-for="item in schema" v-if="item.updateable && item.update && item.filter.type && permissions.u === true">
                <div class="dg-filter-widget-header">
                    <h3>{{item.update.updateLabel}}</h3>
                </div>
                <div class="dg-filter-widget-body">
                    <Form :model="item.update.updateForm" label-position="top">
                        <FormItem>
                            <component :is="element(item.filter.type)"
                                       :model="{form: item.update.updateForm, component: item.model}"
                                       :label="item.update.label ? item.update.label : item.label"
                                       :meta="setMeta(item)">
                            </component>
                        </FormItem>
                        <FormItem>
                            <Button type="primary" long
                                    @click="updateRows(item.update.updateForm, item.model, item.update.refresh)">
                                {{item.update.buttonLabel}}
                            </Button>
                        </FormItem>
                    </Form>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import {element} from "./elements";

    export default {
        props: ["model", "schema", "schemaID", "permissions"],
        methods: {
            element: element,
            setMeta(item) {
                item.schemaID = this.$props.schemaID;
                return item;
            },
            updateRows(updateForm, model, refresh) {

                let selectedNodes = this.$parent.gridApi.getSelectedNodes();

                let selectedData = selectedNodes.map(node => {
                    return node.data[this.$parent.identity]
                });
                if (selectedData.length >= 1) {
                    let updateData = {
                        ids: selectedData,
                        value: updateForm[model],
                        model: model
                    };
                    axios.post(`/lambda/krud/update-row/${this.$parent.schemaID}`, updateData).then(res => {
                        if (res.data.status) {
                            if (refresh) {
                                this.$parent.refresh();
                            }
                            this.$Message.success('Амжилттай шинэчлэгдлээ');

                            // updateForm[model] = null;

                        } else {
                            this.$Message.error('Шинэчлэх үед алдаа гарлаа');
                        }
                    }).catch(e => {
                        this.$Message.error('Шинэчлэх үед алдаа гарлаа');
                    });

                } else {
                    this.$Message.warning('Шинэчлэх мөрөө сонгоно уу');
                }

            },
        }
    };
</script>
