<template>
    <div class="expand">
        <Tabs :animated="false" size="small" class="expand-tab">
            <TabPane label="Үндсэн тохиргоо">
                <Row type="flex">
                    <Col :xs="12" class="rel-col">
                        <ul>
                            <li v-if="item.gridType == 'Link'">
                                <label>Холбоосийн тохиргоо |
                                    <small>http://google.com/{id}/{model}</small>
                                </label>
                                <Input v-model="item.link" placeholder="Холбоос оруулах"/>
                            </li>
                            <li v-if="item.gridType == 'Link'">
                                <label>Холбоосийн айкон</label>
                                <Input v-model="item.icon" placeholder="Холбоос айкон"/>
                            </li>
                            <li v-if="item.gridType == 'Link'">
                              <label>Зөвхөн айкон харуулах</label>
                              <i-switch v-model="item.showOnlyIcon" size="small"></i-switch>
                            </li>
                            <li>
                              <label>Багана хадах</label>
                              <i-switch v-model="item.pinned" size="small"></i-switch>
                            </li>
                            <li v-if="item.gridType == 'Link'">
                                <label>Холбоосийн төрөл</label>
                                <Select v-model="item.linkTarget" placeholder="Холбоосийн төрөл" :width="250">
                                    <Option v-for="item in linkTargets" :value="item" :key="item">{{ item }}</Option>
                                </Select>
                            </li>

                            <li>
                                <label>Багана хадах</label>
                                <i-switch v-model="item.pinned" size="small"></i-switch>
                            </li>
                            <li v-if="item.pinned">
                                <label>Хадах байршил</label>
                                <RadioGroup v-model="item.pinPosition">
                                    <Radio label="left">
                                        <span>Зүүн талд</span>
                                    </Radio>
                                    <Radio label="right">
                                        <span>Баруун талд</span>
                                    </Radio>
                                </RadioGroup>
                            </li>
                        </ul>
                    </Col>
                </Row>
            </TabPane>

            <TabPane label="Radio тохиргоо" v-if="item.gridType == 'Radio'">
                <Row type="flex">
                    <Col :xs="24" :sm="24" :md="12" :lg="12">
                        <div class="expand-grid">
                            <Form ref="optionFrm" :model="optionForm" :rules="optionRule" inline>
                                <FormItem prop="value">
                                    <Input type="text" v-model="optionForm.value" placeholder="Утга"/>
                                </FormItem>
                                <FormItem prop="label">
                                    <Input type="text" v-model="optionForm.label" placeholder="Харагдах үг"/>
                                </FormItem>
                                <FormItem>
                                    <Button type="primary" @click="addOption">Нэмэх</Button>
                                </FormItem>
                            </Form>

                            <Table border size="small" :columns="optionsColumns"
                                   :data="item.options ? item.options : []"
                                   height="250"></Table>
                        </div>
                    </Col>
                </Row>
            </TabPane>

            <TabPane label="Нэмэлт тохиргоо" v-if="item.gridType == 'Custom'">
                <Row type="flex">
                    <Col :xs="24" :sm="24" :md="24" :lg="24">
                        <div class="expand-grid">
                            <Form ref="customFrm" :model="customEl.form" :rules="customEl.rule" inline>
                                <FormItem prop="value">
                                    <Input type="text" v-model="customEl.form.compareVal"
                                           placeholder="Харьцуулах утга"/>
                                </FormItem>
                                <FormItem prop="label">
                                    <Input type="text" v-model="customEl.form.label" placeholder="Харагдах үг"/>
                                </FormItem>
                                <FormItem prop="icon">
                                    <Input type="text" v-model="customEl.form.icon" placeholder="Айкон"/>
                                </FormItem>
                                <FormItem prop="color">
                                    <!--<ColorPicker v-model="customEl.form.color"/>-->
                                    <Input type="text" v-model="customEl.form.color" placeholder="Өнгөний код"/>
                                </FormItem>
                                <FormItem prop="image">
                                    <Input type="text" v-model="customEl.form.image" placeholder="Зураг"/>
                                </FormItem>
                                <FormItem>
                                    <Button type="primary" @click="addCustomEl">Нэмэх</Button>
                                </FormItem>
                            </Form>

                            <Table border size="small" :columns="customEl.columns"
                                   :data="item.options ? item.options : []"
                                   height="250"></Table>
                        </div>
                    </Col>
                </Row>
            </TabPane>

            <TabPane label="Өгөгдлийн тохиргоо">
                <Row type="flex">
                    <Col :xs="24" :sm="24" :md="12" :lg="12" class="rel-col">
                        <div class="title">
                            <h3>Өгөгдлийн холбоос </h3>
                        </div>

                        <ul>
                            <li>
                                <label>Хүснэгт</label>
                                <Select v-model="item.relation.table" placeholder="Хүснэгт сонгох" clearable filterable
                                        @on-change="relationSchema">
                                    <OptionGroup label="Table list">
                                        <Option v-for="item in tableList" :value="item" :key="item.index">{{ item }}
                                        </Option>
                                    </OptionGroup>
                                    <OptionGroup label="View list">
                                        <Option v-for="item in viewList" :value="item" :key="item.index">{{ item }}
                                        </Option>
                                    </OptionGroup>
                                </Select>
                            </li>
                            <li>
                                <label>Холбогдох талбар</label>
                                <Select v-model="item.relation.key" placeholder="Холбогдох талбар" clearable filterable>
                                    <Option v-for="item in relSchema" :value="item.model" :key="item.index">{{
                                        item.model }}
                                    </Option>
                                </Select>
                            </li>
                            <li>
                                <label>Харагдах талбар</label>
                                <Select v-model="item.relation.fields" placeholder="Талбарууд сонгох" clearable
                                        filterable>
                                    <Option v-for="item in relSchema" :value="item.model" :key="item.index">{{
                                        item.model }}
                                    </Option>
                                </Select>
                            </li>
                            <li>
                                <label>Эрэмбэлэх талбар</label>
                                <Select v-model="item.relation.sortField" placeholder="Талбар сонгох" clearable
                                        filterable>
                                    <Option v-for="item in relSchema" :value="item.model" :key="item.index">{{
                                        item.model }}
                                    </Option>
                                </Select>
                            </li>
                            <li>
                                <label></label>
                                <RadioGroup v-model="item.relation.sortOrder">
                                    <Radio label="asc">
                                        <Icon type="arrow-up-c"></Icon>
                                        <span>A-Z</span>
                                    </Radio>
                                    <Radio label="desc">
                                        <Icon type="arrow-down-c"></Icon>
                                        <span>Z-A</span>
                                    </Radio>
                                </RadioGroup>
                            </li>
                        </ul>
                    </Col>

                    <Col :xs="24" :sm="24" :md="12" :lg="8" class="rel-col">
                        <div class="title">
                            <h3>Холбоосийн нөхцөл </h3>
                        </div>
                        <query-builder v-if="relSchema && relSchema.length >=1" @change="changeItemFilter"
                                       :query="item.relation.filter" :fields="relSchema"></query-builder>


                    </Col>
                </Row>
            </TabPane>
        </Tabs>
    </div>
</template>

<script>
    import {elementList} from "./elements";
    import ColorPicker from "./elements/ColorPicker";
    import {getTableMeta} from "./utils/helpers";
    export default {
        components: {ColorPicker},
        props: ["item", "edit"],
        data() {
            return {
                expanded: false,
                tableList: window.init.dbSchema.tableList,
                viewList: window.init.dbSchema.viewList,
                elementList: elementList,
                relSchema: [],
                customEl: {
                    form: {
                        compareVal: null,
                        label: null,
                        color: '#666666',
                        icon: null,
                        image: null
                    },
                    rule: {
                        compareVal: [{required: true, message: "Утга оруулна уу", trigger: "blur"}]
                    },
                    columns: [
                        {
                            title: 'Утга',
                            key: "compareVal",
                        },
                        {
                            title: 'Харагдах үг',
                            key: "label",
                        },
                        {
                            title: 'Өнгө',
                            key: "color",
                        },
                        {
                            title: 'Айкон',
                            key: "icon",
                        },
                        {
                            title: 'Зураг',
                            key: "image",
                        },
                        {
                            title: "Устгах",
                            key: "action",
                            width: 100,
                            align: "center",
                            render: (h, params) => {
                                return h("div", [
                                    h(
                                        "Button",
                                        {
                                            props: {
                                                type: "error",
                                                size: "small"
                                            },
                                            on: {
                                                click: () => {
                                                    this.removeOption(params.index);
                                                }
                                            }
                                        },
                                        "Устгах"
                                    )
                                ]);
                            }
                        }
                    ]
                },

                optionForm: {
                    value: null,
                    label: null
                },
                optionRule: {
                    value: [{required: true, message: "Утга оруулна уу", trigger: "blur"}],
                    label: [{required: true, message: "Харагдах үгээ оруулна уу", trigger: "blur"}]
                },
                optionsColumns: [
                    {
                        title: 'Утга',
                        key: "value"
                    },
                    {
                        title: 'Харагдах үг',
                        key: "label"
                    },
                    {
                        title: "Устгах",
                        key: "action",
                        width: 100,
                        align: "center",
                        render: (h, params) => {
                            return h("div", [
                                h(
                                    "Button",
                                    {
                                        props: {
                                            type: "error",
                                            size: "small"
                                        },
                                        on: {
                                            click: () => {
                                                this.removeOption(params.index);
                                            }
                                        }
                                    },
                                    "Устгах"
                                )
                            ]);
                        }
                    }
                ],

                linkTargets: ['_blank', '_new', '_self', '_top'],
            };
        },
        created() {
            if (this.item.relation.table !== null) {
                this.relationSchema(this.item.relation.table);
            }
        },
        methods: {
            async relationSchema(val) {
              this.relSchema = await getTableMeta(val);
            },

            //Filter event
            changeItemFilter(query) {
                if (query) {
                    this.$props.item.relation.filter = query.sql;
                } else {
                    this.$props.item.relation.filter = undefined;
                }
            },

            addOption() {
                this.$refs["optionFrm"].validate(valid => {
                    if (valid) {
                        this.item.options.push({...this.optionForm});
                        this.optionForm = {value: null, label: null};
                    }
                });
            },

            addCustomEl() {
                this.$refs["customFrm"].validate(valid => {
                    if (valid) {
                        this.item.options.push({...this.customEl.form});
                        this.$refs["customFrm"].resetFields();
                    }
                });
            },

            removeOption(index) {
                this.item.options.splice(index, 1);
            }
        }
    };
</script>


